<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pollito's Albion Map Viewer</title>
<style>
/* ===================== Estilos originales ===================== */
body { font-family:'Segoe UI',sans-serif;background:#111;color:#eee;margin:0 }
h1{text-align:center;margin:20px 0}
#maps{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;padding:10px}
.map{border:1px solid #444;border-radius:12px;padding:10px;background:#222;cursor:pointer;transition:.25s;position:relative}
.map:hover{transform:scale(1.05);box-shadow:0 0 15px #e53935}
.map img{max-width:100%;border-radius:6px;margin-bottom:6px}
.map h3{text-align:center;margin:5px 0 10px}
.resources{display:flex;gap:6px;justify-content:center;flex-wrap:wrap}
.icon-wrapper{position:relative}
.icon-wrapper img{width:22px;height:22px}
.icon-badge{position:absolute;top:-6px;right:-6px;background:#e53935;color:#fff;font-size:10px;
border-radius:999px;padding:0 4px;min-width:16px;height:16px;display:flex;align-items:center;justify-content:center}
#mapModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75);justify-content:center;align-items:center}
#modalBody img:hover{transform:scale(3);box-shadow:0 0 15px}
.modal-content{background:#222;border-radius:12px;padding:20px;max-width:400px;width:90%}
.closeBtn{position:absolute;top:10px;right:15px;cursor:pointer;color:#e53935}
@media(max-width:1200px){#maps{grid-template-columns:repeat(3,1fr)}}
@media(max-width:900px){#maps{grid-template-columns:repeat(2,1fr)}}
@media(max-width:600px){#maps{grid-template-columns:repeat(1,1fr)}}

/* ===================== Barra de búsqueda Uiverse ===================== */
.grid {
  height: 800px; width: 800px;
  background-image: linear-gradient(to right, #0f0f10 1px, transparent 1px),
                    linear-gradient(to bottom, #0f0f10 1px, transparent 1px);
  background-size: 1rem 1rem;
  background-position: center center;
  position: absolute;
  z-index: -1;
  filter: blur(1px);
}
#poda {
  display: flex; align-items: center; justify-content: center; margin-bottom: 20px;
  position: relative;
}
.white,.border,.darkBorderBg,.glow {
  max-height: 70px; max-width: 314px; height: 100%; width: 100%;
  position: absolute; overflow: hidden; z-index: -1; border-radius: 12px;
  filter: blur(3px);
}
.input {
  background-color: #010201; border: none; width: 301px; height: 56px;
  border-radius: 10px; color: white; padding-inline: 59px; font-size: 18px;
}
.input::placeholder { color: #c0b9c0; }
.input:focus { outline: none; }
#main { position: relative; }
#input-mask { pointer-events: none; width: 100px; height: 20px; position: absolute; background: linear-gradient(90deg, transparent, black); top: 18px; left: 70px; }
#pink-mask { pointer-events: none; width: 30px; height: 20px; position: absolute; background: #cf30aa; top: 10px; left: 5px; filter: blur(20px); opacity: 0.8; transition: all 2s; }
#main:hover > #pink-mask { opacity: 0; }
#filter-icon { position: absolute; top: 8px; right: 8px; display: flex; align-items: center; justify-content: center; z-index: 2; max-height: 40px; max-width: 38px; height: 100%; width: 100%; isolation: isolate; overflow: hidden; border-radius: 10px; background: linear-gradient(180deg, #161329, black, #1d1b4b); border: 1px solid transparent; }
.filterBorder { height: 42px; width: 40px; position: absolute; overflow: hidden; top: 7px; right: 7px; border-radius: 10px; }
#search-icon { position: absolute; left: 20px; top: 15px; }



</style>
</head>
<body>
<h1>Albion Avalon Maps</h1>

<!-- ======= Barra de búsqueda estilo  ======= -->
<div class="grid"></div>
<div id="poda">
  <div class="glow"></div>
  <div class="darkBorderBg"></div>
  <div class="darkBorderBg"></div>
  <div class="darkBorderBg"></div>
  <div class="white"></div>
  <div class="border"></div>

  <div id="main">
    <input id="mapSearch" placeholder="Buscar mapa..." type="text" name="text" class="input" />
    <div id="input-mask"></div>
    <div id="pink-mask"></div>
    <div class="filterBorder"></div>
    <div id="filter-icon">
      <svg preserveAspectRatio="none" height="27" width="27" viewBox="4.8 4.56 14.832 15.408" fill="none">
        <path d="M8.16 6.65002H15.83C16.47 6.65002 16.99 7.17002 16.99 7.81002V9.09002C16.99 9.56002 16.7 10.14 16.41 10.43L13.91 12.64C13.56 12.93 13.33 13.51 13.33 13.98V16.48C13.33 16.83 13.1 17.29 12.81 17.47L12 17.98C11.24 18.45 10.2 17.92 10.2 16.99V13.91C10.2 13.5 9.97 12.98 9.73 12.69L7.52 10.36C7.23 10.08 7 9.55002 7 9.20002V7.87002C7 7.17002 7.52 6.65002 8.16 6.65002Z" stroke="#d6d6e6" stroke-width="1" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"></path>
      </svg>
    </div>
    <div id="search-icon">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" viewBox="0 0 24 24" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" height="24" fill="none" class="feather feather-search">
        <circle stroke="url(#search)" r="8" cy="11" cx="11"></circle>
        <line stroke="url(#searchl)" y2="16.65" y1="22" x2="16.65" x1="22"></line>
        <defs>
          <linearGradient gradientTransform="rotate(50)" id="search">
            <stop stop-color="#f8e7f8" offset="0%"></stop>
            <stop stop-color="#b6a9b7" offset="50%"></stop>
          </linearGradient>
          <linearGradient id="searchl">
            <stop stop-color="#b6a9b7" offset="0%"></stop>
            <stop stop-color="#837484" offset="50%"></stop>
          </linearGradient>
        </defs>
      </svg>
    </div>
  </div>
</div>

<!-- ======= Contenedor de mapas ======= -->
<div id="maps"></div>

<!-- ======= Modal ======= -->
<div id="mapModal">
<div class="modal-content">
<span class="closeBtn">&times;</span>
<div id="modalBody"></div>
</div>
</div>

<script>
// ===================== Variables =====================
const WORKER_URL='https://avalon-maps.pcaternador.workers.dev/';
const ICONS_PATH='./icons/';
let allMaps=[];

const container=document.getElementById('maps');
const searchInput=document.getElementById('mapSearch');
const modal=document.getElementById('mapModal');
const modalBody=document.getElementById('modalBody');

// ===================== Fetch mapas =====================
fetch(WORKER_URL).then(r=>r.json()).then(d=>{
	allMaps=Array.isArray(d[0])?d[0]:d;
	renderMaps(allMaps);
});

// ===================== Modal =====================
document.querySelector('.closeBtn').onclick=()=>modal.style.display='none';
window.onclick=e=>{if(e.target===modal)modal.style.display='none';};

// ===================== Funciones =====================
function appendBadge(wrapper,count){
	const badge=document.createElement('span');
	badge.className='icon-badge';
	badge.textContent=count;
	wrapper.appendChild(badge);
}

const resourceIcons={
leather:'leather.png',wood:'wood.png',stone:'stone.png',fiber:'fiber.png',mineral:'mineral.png',
blue:'blue.png',green:'green.png',cotton:'cotton.png',ore:'ore.png',rock:'rock.png',
gold:'gold.png',dungeon:'dungeon.png',hire:'hire.png',logs:'logs.png'
};

const nodesMap = {
	leather: 'leather_nodes',
	hide: 'leather_nodes',
	logs: 'wood_nodes',
	wood: 'wood_nodes',
	rock: 'stone_nodes',
	stone: 'stone_nodes',
	cotton: 'fiber_nodes',
	fiber: 'fiber_nodes',
	ore: 'mineral_nodes',
	mineral: 'mineral_nodes'
};

const chestTypes=[
{key:'green_chests',icon:'green.png'},
{key:'blue_chests',icon:'blue.png'},
{key:'gold_chests',icon:'gold.png'},
{key:'dungeons',icon:'dungeon.png'}
];

// ===================== Render mapas =====================
function renderMaps(maps) {
    container.innerHTML = '';
    maps.forEach(map => {
        const div = document.createElement('div');
        div.className = 'map';
        const imgSrc = map.image || '';
        div.innerHTML = `<h3>${map.map_name} (T${map.tier})</h3><img src="${imgSrc}">`;

        const resourcesDiv = document.createElement('div');
        resourcesDiv.className = 'resources';
        const iconBySrc = {};

        // Recursos
        (map.resources || []).forEach(r => {
            const key = r.toLowerCase();
            if (!resourceIcons[key]) return;
            const src = ICONS_PATH + resourceIcons[key];
            if (!iconBySrc[src]) {
                const w = document.createElement('div');
                w.className = 'icon-wrapper';
                const i = document.createElement('img'); i.src = src;
                w.appendChild(i);
                resourcesDiv.appendChild(w);
                iconBySrc[src] = w;
            }
            if (nodesMap[key]) {
                const count = Number(map[nodesMap[key]]) || 0;
                if (count > 1) appendBadge(iconBySrc[src], count);
            }
        });

        // Cofres
        chestTypes.forEach(c => {
            const count = Number(map[c.key]) || 0;
            if (count <= 0) return;
            const src = ICONS_PATH + c.icon;
            if (!iconBySrc[src]) {
                const w = document.createElement('div');
                w.className = 'icon-wrapper';
                const i = document.createElement('img'); i.src = src;
                w.appendChild(i);
                resourcesDiv.appendChild(w);
                iconBySrc[src] = w;
            }
            appendBadge(iconBySrc[src], count);
        });

        div.appendChild(resourcesDiv);
        container.appendChild(div);

        // Modal
        div.onclick = () => {
            const list = Object.entries(nodesMap).map(([k,v])=>`<li>${k}: ${map[v]||0}</li>`).join('');
            modalBody.innerHTML = `<h2>${map.map_name} (T${map.tier})</h2><img src="${imgSrc}" style="width:100%;border-radius:6px"><ul style="text-align:left">${list}</ul>`;
            modal.style.display = 'flex';
        };
    });
}

// ===================== Filtro búsqueda =====================
searchInput.oninput = () => {
    const q = searchInput.value.toLowerCase();
    renderMaps(allMaps.filter(m=>m.map_name.toLowerCase().includes(q)));
};
</script>
</body>
</html>
