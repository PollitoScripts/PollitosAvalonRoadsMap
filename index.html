<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Albion Map Viewer</title>
  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      padding: 0;
    }

    h1 { text-align: center; margin: 20px 0; }

    #filters, #search-container {
      text-align: center;
      margin-bottom: 15px;
    }

    #filters select, #search-container input {
      padding: 5px 10px;
      margin: 0 5px;
      border-radius: 5px;
    }

    #maps {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      padding: 10px;
    }

    .map {
      border: 1px solid #444;
      border-radius: 8px;
      padding: 10px;
      width: 220px;
      background: #222;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    .map:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px #888;
    }

    .map img {
      max-width: 100%;
      border-radius: 4px;
      margin-bottom: 5px;
    }

    .map h3 { margin: 5px 0; font-size: 1.1em; }
    .resources, .chests {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin: 3px 0;
    }
    .resources img, .chests img {
      width: 20px;
      height: 20px;
    }

    .tooltip {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0,0,0,0.7);
      padding: 5px;
      font-size: 0.8em;
      border-radius: 5px;
      display: none;
      z-index: 10;
    }
    .map:hover .tooltip { display: block; }
  </style>
</head>
<body>
  <h1>Albion Maps</h1>

  <!-- Barra de búsqueda -->
  <div id="search-container">
    <input type="text" id="mapSearch" placeholder="Buscar mapa...">
  </div>

  <!-- Filtros -->
  <div id="filters">
    Tier:
    <select id="tierFilter">
      <option value="all">Todos</option>
      <option value="4">T4</option>
      <option value="5">T5</option>
      <option value="6">T6</option>
      <option value="7">T7</option>
      <option value="8">T8</option>
    </select>

    Recurso:
    <select id="resourceFilter">
      <option value="all">Todos</option>
      <option value="WOOD">Madera</option>
      <option value="STONE">Piedra</option>
      <option value="ORE">Minerales</option>
      <option value="FIBER">Fibra</option>
      <option value="LEATHER">Cuero</option>
      <option value="BLUE">Blue Chest</option>
      <option value="GREEN">Green Chest</option>
      <option value="GOLD">Gold Chest</option>
      <option value="DUNGEON">Dungeon</option>
    </select>
  </div>

  <div id="maps"></div>

  <script>
    const WORKER_URL = 'https://avalon-maps.pcaternador.workers.dev/';
    const ICONS_PATH = './icons/';
    let allMaps = [];

    const container = document.getElementById('maps');
    const tierSelect = document.getElementById('tierFilter');
    const resourceSelect = document.getElementById('resourceFilter');
    const searchInput = document.getElementById('mapSearch');

    // Carga de mapas
    fetch(WORKER_URL)
      .then(res => res.json())
      .then(data => {
        allMaps = Array.isArray(data[0]) ? data[0] : data;
        renderMaps(allMaps);
      })
      .catch(err => console.error('Error fetch:', err));

    function renderMaps(maps) {
      container.innerHTML = '';
      maps.forEach(map => {
        const resourcesDiv = document.createElement('div');
        resourcesDiv.className = 'resources';
        const mapResourcesKey = Object.keys(map).find(k => k.toLowerCase() === 'resources');
        const mapResources = mapResourcesKey ? map[mapResourcesKey] : [];
        mapResources.forEach(r => {
          const img = document.createElement('img');
          img.src = ICONS_PATH + r.toLowerCase() + '.png';
          img.alt = r;
          resourcesDiv.appendChild(img);
        });

        const chestsDiv = document.createElement('div');
        chestsDiv.className = 'chests';
        const chestTypes = ['green_chests','blue_chests','gold_chests','dungeons'];
        chestTypes.forEach(type => {
          const count = map[type] || 0;
          const iconName = type.replace('_chests','').replace('dungeons','dungeon') + '.png';
          for(let i=0;i<count;i++){
            const img = document.createElement('img');
            img.src = ICONS_PATH + iconName;
            img.alt = type;
            chestsDiv.appendChild(img);
          }
        });

        let imgSrc = map.image ? encodeURI(map.image.replace(/\\/g,'/')) : 'https://via.placeholder.com/220x150?text=No+Image';

        const div = document.createElement('div');
        div.className = 'map';

        const tooltipHTML = `
          <p>Leather: ${map.leather_nodes || 0}</p>
          <p>Wood: ${map.wood_nodes || 0}</p>
          <p>Stone: ${map.stone_nodes || 0}</p>
          <p>Fiber: ${map.fiber_nodes || 0}</p>
          <p>Mineral: ${map.mineral_nodes || 0}</p>
        `;

        div.innerHTML = `
          <h3>${map.map_name || 'Sin nombre'} (T${map.tier || '?'})</h3>
          <img src="${imgSrc}" alt="${map.map_name || ''}">
        `;
        div.appendChild(resourcesDiv);
        div.appendChild(chestsDiv);

        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        tooltip.innerHTML = tooltipHTML;
        div.appendChild(tooltip);

        container.appendChild(div);
      });
    }

    // Función de filtrado combinada
    function applyFilters() {
      const query = searchInput.value.toLowerCase().trim();
      const tierValue = tierSelect.value;
      const resourceValue = resourceSelect.value.toUpperCase();

      const filtered = allMaps.filter(map => {
        // Detectamos las claves correctas
        const tierKey = Object.keys(map).find(k=>k.toLowerCase()==='tier');
        const resourcesKey = Object.keys(map).find(k=>k.toLowerCase()==='resources');

        const mapTier = tierKey ? String(map[tierKey]) : '';
        const mapResources = resourcesKey ? (map[resourcesKey]||[]).map(r=>r.toUpperCase()) : [];
        const name = map.map_name || '';

        const tierMatch = tierValue==='all' || mapTier===tierValue;
        const resourceMatch = resourceValue==='all' || mapResources.includes(resourceValue);
        const searchMatch = query==='' || name.toLowerCase().includes(query);

        return tierMatch && resourceMatch && searchMatch;
      });

      if(filtered.length===0){
        container.innerHTML='<p style="text-align:center; color:#f88;">No se encontraron mapas.</p>';
      } else {
        renderMaps(filtered);
      }
    }

    // Eventos
    tierSelect.addEventListener('change', applyFilters);
    resourceSelect.addEventListener('change', applyFilters);
    searchInput.addEventListener('input', applyFilters);
  </script>
</body>
</html>

