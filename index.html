<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Pollito's Albion Map Viewer</title>

  <style>
    body {
      font-family: sans-serif;
      background: #111;
      color: #eee;
      margin: 0;
      padding: 0;
    }

    h1 { text-align: center; margin: 20px 0; }

    #search-container {
      text-align: center;
      margin-bottom: 15px;
    }

    #search-container input {
      padding: 5px 10px;
      width: 250px;
      border-radius: 5px;
      border: 1px solid #555;
      background: #222;
      color: #eee;
    }

    #maps {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      padding: 10px;
    }

    .map {
      border: 1px solid #444;
      border-radius: 8px;
      padding: 10px;
      width: 220px;
      background: #222;
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }

    .map:hover {
      transform: scale(1.05);
      box-shadow: 0 0 15px #888;
    }

    .map img {
      max-width: 100%;
      border-radius: 4px;
      margin-bottom: 5px;
    }

    .map h3 {
      margin: 5px 0;
      font-size: 1.1em;
    }

    .resources, .chests {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 4px 0;
    }

    .icon-wrapper {
      position: relative;
      display: inline-block;
    }

    .icon-wrapper img {
      width: 20px;
      height: 20px;
    }

    .icon-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      min-width: 14px;
      height: 14px;
      padding: 0 4px;
      background: #e53935;
      color: #fff;
      font-size: 10px;
      font-weight: bold;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 1px #111;
    }

    .tooltip {
      position: absolute;
      top: 5px;
      right: 5px;
      background: rgba(0,0,0,0.7);
      padding: 5px;
      font-size: 0.8em;
      border-radius: 5px;
      display: none;
      z-index: 10;
    }

    .map:hover .tooltip {
      display: block;
    }
  </style>
</head>

<body>
  <h1>Albion Avalon-Maps</h1>

  <div id="search-container">
    <input type="text" id="mapSearch" placeholder="Buscar mapa...">
  </div>

  <div id="maps"></div>

  <script>
    const WORKER_URL = 'https://avalon-maps.pcaternador.workers.dev/';
    const ICONS_PATH = './icons/';
    let allMaps = [];

    const container = document.getElementById('maps');
    const searchInput = document.getElementById('mapSearch');

    fetch(WORKER_URL)
      .then(res => res.json())
      .then(data => {
        allMaps = Array.isArray(data[0]) ? data[0] : data;
        renderMaps(allMaps);
      })
      .catch(err => console.error('Error fetch:', err));

    function renderMaps(maps) {
      container.innerHTML = '';

      maps.forEach(map => {
        const div = document.createElement('div');
        div.className = 'map';

        const imgSrc = map.image
          ? encodeURI(map.image.replace(/\\/g, '/'))
          : 'https://via.placeholder.com/220x150?text=No+Image';

        div.innerHTML = `
          <h3>${map.map_name || 'Sin nombre'} (T${map.tier || '?'})</h3>
          <img src="${imgSrc}">
        `;

        /* ===== RESOURCES ===== */
        const resourcesDiv = document.createElement('div');
        resourcesDiv.className = 'resources';

        const resourceIcons = ['leather', 'wood', 'stone', 'fiber', 'mineral'];

        const resourcesKey = Object.keys(map).find(
          k => k.toLowerCase() === 'resources'
        );
        const resourcesArray = resourcesKey ? map[resourcesKey] : [];

        resourceIcons.forEach(res => {
          const nodeCount = Number(map[`${res}_nodes`]) || 0;

          const existsInResources =
            Array.isArray(resourcesArray) &&
            resourcesArray.some(r => r.toLowerCase() === res);

          if (nodeCount <= 0 && !existsInResources) return;

          const count = nodeCount > 0 ? nodeCount : 1;

          const wrapper = document.createElement('div');
          wrapper.className = 'icon-wrapper';

          const img = document.createElement('img');
          img.src = ICONS_PATH + res + '.png';
          img.alt = res;

          wrapper.appendChild(img);

          if (count > 1) {
            const badge = document.createElement('span');
            badge.className = 'icon-badge';
            badge.textContent = count;
            wrapper.appendChild(badge);
          }

          resourcesDiv.appendChild(wrapper);
        });

        /* ===== CHESTS ===== */
        const chestsDiv = document.createElement('div');
        chestsDiv.className = 'chests';

        const chestTypes = [
          { key: 'green_chests', icon: 'green.png' },
          { key: 'blue_chests', icon: 'blue.png' },
          { key: 'gold_chests', icon: 'gold.png' },
          { key: 'dungeons', icon: 'dungeon.png' }
        ];

        chestTypes.forEach(({ key, icon }) => {
          const count = Number(map[key]) || 0;
          if (count <= 0) return;

          const wrapper = document.createElement('div');
          wrapper.className = 'icon-wrapper';

          const img = document.createElement('img');
          img.src = ICONS_PATH + icon;
          img.alt = key;

          wrapper.appendChild(img);

          if (count > 1) {
            const badge = document.createElement('span');
            badge.className = 'icon-badge';
            badge.textContent = count;
            wrapper.appendChild(badge);
          }

          chestsDiv.appendChild(wrapper);
        });

        /* ===== TOOLTIP ===== */
        const tooltip = document.createElement('div');
        tooltip.className = 'tooltip';
        tooltip.innerHTML = `
          <p>Leather: ${map.leather_nodes || 0}</p>
          <p>Wood: ${map.wood_nodes || 0}</p>
          <p>Stone: ${map.stone_nodes || 0}</p>
          <p>Fiber: ${map.fiber_nodes || 0}</p>
          <p>Mineral: ${map.mineral_nodes || 0}</p>
        `;

        div.appendChild(resourcesDiv);
        div.appendChild(chestsDiv);
        div.appendChild(tooltip);

        container.appendChild(div);
      });
    }

    searchInput.addEventListener('input', () => {
      const q = searchInput.value.toLowerCase().trim();
      const filtered = allMaps.filter(m =>
        (m.map_name || '').toLowerCase().includes(q)
      );
      renderMaps(filtered);
    });
  </script>
</body>
</html>

